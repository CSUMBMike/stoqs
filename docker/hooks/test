#!/bin/bash
# Use /src/${BUILD_CODE} for STOQS_HOME in docker-compose.test.yml
# The working directory for this script in docker cloud is $STOQS_HOME/docker

echo "==> hooks/test"

if [ $GIT_BRANCH == 'MBARIMike:master' ] 
then
    $YML='docker-compose.test.mbarimike.yml'
else
    $YML='docker-compose.test.yml'
fi

echo "*** docker-compose -f $YML up -d"
docker-compose -f $YML up -d

# Wait for test.sh to start, then check that it finishes before stopping the services
echo
docker exec stoqs ps -ef | grep test.sh | grep -v grep
while [[ $? == 1 ]] ; do
    sleep 30; echo "*** Waiting for test.sh to start ..."
    docker exec stoqs ps -ef | grep test.sh | grep -v grep
done

docker exec stoqs ps -ef | grep test.sh | grep -v grep
while [[ $? == 0 ]] ; do
    sleep 30; echo "*** Waiting for test.sh to complete ..."
    docker exec stoqs ps -ef | grep test.sh | grep -v grep
done

echo "*** docker-compose -f $YML logs"
docker-compose -f $YML logs

echo "*** docker-compose -f $YML stop"
docker-compose -f $YML stop
